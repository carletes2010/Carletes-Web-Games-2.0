<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Instituto de Biologia Mexicana</title>

  <!-- Google Font: Lexend Deca -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #ffffff;
      --fg: #0a0a0a;
      --muted: #444;
      --card: #f9fafb;
      --stroke: #e5e7eb;
      --accent: #1d4ed8;
      --accent-dark: #1e3a8a;
      --radius: 16px;
      --shadow: 0 6px 18px rgba(0,0,0,.08);
      --pad: clamp(14px, 2.4vw, 24px);
    }
    @media (prefers-color-scheme: dark){
      :root {
        --bg: #0a0a0a;
        --fg: #f9fafb;
        --muted: #9ca3af;
        --card: #111;
        --stroke: #222;
        --accent: #3b82f6;
        --accent-dark: #2563eb;
        --shadow: 0 8px 20px rgba(0,0,0,.5);
      }
    }

    * { box-sizing: border-box; }
    html, body { margin: 0; height: 100%; background: var(--bg); color: var(--fg); font-family: 'Lexend Deca', sans-serif; -webkit-font-smoothing: antialiased; }
    a { color: inherit; text-decoration: none; }

    .wrap { max-width: 1100px; margin: 0 auto; padding: max(20px, env(safe-area-inset-top)) 20px max(24px, env(safe-area-inset-bottom)); }

    /* Buttons */
    .btn { padding: 12px 20px; font-weight: 700; border-radius: 12px; border: 1px solid var(--accent); background: var(--accent); color: #fff; transition: background .2s ease, transform .1s ease; cursor: pointer; }
    .btn:hover { background: var(--accent-dark); }
    .btn:active { transform: scale(.98); }
    .btn.ghost { background: transparent; color: var(--accent); }
    .btn.ghost:hover { background: var(--accent); color:#fff; }
    .btn.full { width: 100%; }

    /* ======= LOGIN VIEW ======= */
    .center-screen { min-height: 100dvh; display: grid; place-items: center; padding: 20px; }
    .auth-card { width: 100%; max-width: 460px; background: var(--card); border: 1px solid var(--stroke); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; text-align: left; }
    .hero { text-align: center; padding: 16px; background: var(--card); border: 1px solid var(--stroke); border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 16px; }
    .badge { display: inline-block; font-size: 13px; font-weight: 600; color: var(--accent); padding: 6px 12px; border: 1px solid var(--accent); border-radius: 999px; margin-bottom: 12px; }
    .title { font-size: clamp(24px, 5vw, 32px); font-weight: 800; margin: 0 0 6px; }
    .subtitle { font-size: 16px; color: var(--muted); margin: 0; line-height: 1.5; }
    .tabs { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 8px; border: 1px solid var(--stroke); border-radius: 12px; margin-top: 8px; }
    .tab { text-align: center; padding: 10px 12px; border-radius: 10px; font-weight: 700; color: var(--muted); border: 1px solid transparent; cursor: pointer; }
    .tab.active { color: var(--fg); border-color: var(--stroke); background: rgba(0,0,0,.03); }
    .field { margin: 10px 0; }
    .label { font-size: 13px; font-weight: 700; margin-bottom: 6px; }
    input[type="email"], input[type="password"], input[type="text"]{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--stroke); background:#fff0; color:var(--fg); outline:none; }
    input::placeholder { color: var(--muted); }
    .notice { border: 1px dashed var(--stroke); color: var(--muted); padding: 12px; border-radius: 12px; font-size: 14px; }

    /* Modal legal */
    .modal-backdrop{ position: fixed; inset:0; background: rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; padding: 20px; }
    .modal{ width: 100%; max-width: 560px; background: var(--card); border: 1px solid var(--stroke); border-radius: 18px; box-shadow: var(--shadow); padding: 20px; text-align: left; }
    .modal h2{ margin: 0 0 6px; font-size: 20px; }
    .modal p{ color: var(--muted); margin: 0; }
    .modal .actions{ display:flex; gap:10px; margin-top:16px; }

    .hidden { display: none !important; }

    /* ======= APP (CAT√ÅLOGO) VIEW ======= */
    .topbar { position: sticky; top: 0; z-index: 10; backdrop-filter: blur(6px); background: color-mix(in srgb, var(--bg) 88%, transparent); border-bottom: 1px solid var(--stroke); }
    .topbar-inner { max-width: 1100px; margin: 0 auto; padding: 10px 20px; display: flex; align-items: center; gap: 10px; justify-content: space-between; position: relative; }
    .profile { display:flex; align-items:center; gap:10px; color: var(--muted); font-size: 14px; cursor: pointer; }
    .profile .avatar { width:32px; height:32px; border-radius:999px; border:1px solid var(--stroke); object-fit: cover; }
    .profile-menu { position: absolute; right: 20px; top: 60px; background: var(--card); border: 1px solid var(--stroke); border-radius: 12px; box-shadow: var(--shadow); padding: 10px; width: 240px; z-index: 20; }

    .hero-catalog { text-align: center; padding: 80px 20px; background: var(--card); border: 1px solid var(--stroke); border-radius: 20px; box-shadow: var(--shadow); margin: 20px 0 30px; }
    .title-xl { font-size: clamp(28px, 6vw, 48px); font-weight: 800; margin: 0 0 12px; color: var(--fg); }
    .subtitle-lg { font-size: 16px; color: var(--muted); max-width: 740px; margin: 0 auto 24px; line-height: 1.5; }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
    .card { background: var(--card); border: 1px solid var(--stroke); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; transition: transform .15s ease; }
    .card:hover { transform: translateY(-3px); }
    .thumb { display: block; width: 100%; aspect-ratio: 16/11; object-fit: contain; background: #fff; }
    .meta { padding: 12px 14px; display: flex; align-items: center; justify-content: space-between; }
    .title-game { font-weight: 700; font-size: 15px; }
    .play { padding: 6px 12px; font-size: 14px; font-weight: 600; border: 1px solid var(--accent); border-radius: 8px; color: var(--accent); transition: background .2s ease, color .2s ease; }
    .play:hover { background: var(--accent); color: #fff; }

    footer { margin-top: 40px; text-align: center; color: var(--muted); font-size: 14px; }

    /* ===== Player (detalle de juego) ===== */
    .header{ position: sticky; top: 0; z-index: 20; padding: 10px var(--pad); margin: 0 0 8px; background: color-mix(in srgb, var(--bg) 75%, transparent); -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px); border-bottom: 1px solid var(--stroke); display:flex; align-items:center; justify-content:center; }
    .logo{ position: absolute; left: max(12px, env(safe-area-inset-left)); top: 50%; transform: translateY(-50%); display:flex; align-items:center; gap:8px; }
    .logo img{ width: 28px; height: 28px; border-radius: 8px; display:block; }
    .brand{ font-weight: 800; font-size: 14px; color: var(--accent) }
    .title{ margin: 0; text-align:center; font-weight: 800; font-size: clamp(18px, 3.6vw, 28px); letter-spacing: .2px; }
    .stage{ margin-top: 14px; background: var(--card); border: 1px solid var(--stroke); border-radius: 20px; box-shadow: var(--shadow); overflow: clip; }
    .stage-inner{ width: 100%; aspect-ratio: 16 / 9; height: clamp(380px, 72svh, 860px); max-height: calc(100svh - 160px); display: grid; place-items: center; background: #000; }
    .game{ width: 100%; height: 100%; border: 0; background: #000; }
    .controls{ display:flex; gap:10px; justify-content:space-between; align-items:center; padding: 10px 12px; border-top: 1px solid var(--stroke); background: color-mix(in srgb, var(--bg) 60%, transparent); }
    .hint{ font-size: 12px; color: var(--muted) }
    .panic{ position: fixed; right: max(12px, env(safe-area-inset-right)); bottom: max(12px, env(safe-area-inset-bottom)); z-index: 50; padding: 14px 18px; border-radius: 14px; font-weight: 900; border: 2px solid #000; background: #000; color:#fff; box-shadow: 0 6px 18px rgba(0,0,0,.22); letter-spacing:.2px; }
    .panic:active{ transform: translateY(1px) }
  </style>
</head>
<body>
  <!-- ===== LOGIN ===== -->
  <div id="authView" class="center-screen">
    <div class="auth-card">
      <div class="hero">
        <div class="badge">Acceso a Carletes Games</div>
        <h1 class="title">Inicia sesi√≥n para continuar</h1>
        <p class="subtitle">Crea tu cuenta con nombre/apodo o usa Google.</p>
      </div>

      <div id="authArea">
        <div class="tabs" role="tablist" aria-label="Modo de acceso">
          <div id="tab-login"  class="tab active" role="tab" tabindex="0">Iniciar sesi√≥n</div>
          <div id="tab-signup" class="tab"        role="tab" tabindex="0">Crear cuenta</div>
        </div>

        <!-- Login -->
        <div id="panel-login" style="margin-top:12px;">
          <div class="field">
            <div class="label">Correo</div>
            <input id="login-email" type="email" placeholder="tu@correo.com" autocomplete="email" />
          </div>
          <div class="field">
            <div class="label">Contrase√±a</div>
            <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          </div>
          <button id="btn-login-email" class="btn full">Iniciar sesi√≥n</button>
        </div>

        <!-- Signup -->
        <div id="panel-signup" style="margin-top:12px; display:none;">
          <div class="field">
            <div class="label">Nombre</div>
            <input id="signup-name" type="text" placeholder="Tu nombre" autocomplete="name" />
          </div>
          <div class="field">
            <div class="label">Apodo</div>
            <input id="signup-nick" type="text" placeholder="Tu apodo" />
          </div>
          <div class="field">
            <div class="label">Correo</div>
            <input id="signup-email" type="email" placeholder="tu@correo.com" autocomplete="email" />
          </div>
          <div class="field">
            <div class="label">Contrase√±a (m√≠n. 6)</div>
            <input id="signup-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" />
          </div>
          <button id="btn-signup-email" class="btn full">Crear cuenta</button>
        </div>

        <div style="height:12px"></div>
        <button id="btn-google" class="btn ghost full">Continuar con Google</button>

        <div style="height:12px"></div>
        <div id="status" class="notice">Esperando autenticaci√≥n‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- ===== APP / CAT√ÅLOGO ===== -->
  <div id="appView" class="hidden">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="profile" id="profileBtn">
          <img id="avatar" class="avatar" alt="avatar" src="" onerror="this.style.display='none'"/>
          <div>
            <div style="font-weight:700">Bienvenido, <span id="userName">usuario</span></div>
            <div style="font-size:12px; color:var(--muted)">Apodo: <span id="userNick">‚Äî</span></div>
          </div>
        </div>
        <div class="profile-menu hidden" id="profileMenu">
          <button id="btn-copy-link" class="btn full">Copiar enlace con usuario</button>
          <div style="height:8px"></div>
          <button id="btn-logout" class="btn ghost full">Cerrar sesi√≥n</button>
        </div>
      </div>
    </div>

    <div class="wrap">
      <!-- Hero cat√°logo -->
      <section class="hero-catalog">
        <div class="badge">üéÆ Carletes Games</div>
        <h1 class="title-xl">Carletes Games ha vuelto</h1>
        <p id="welcome" class="subtitle-lg"></p>
        <div class="cta" style="display:flex; justify-content:center; gap:12px;">
          <a href="#menu" class="btn">Entrar a jugar</a>
          <a href="#menu" id="btn-random" class="btn ghost">Elegir un juego random</a>
        </div>
      </section>

      <!-- Men√∫ de juegos (se llena por JS) -->
      <main id="menu" class="grid"></main>

      <!-- Player (detalle de juego en la misma p√°gina) -->
      <section id="playerView" class="hidden">
        <div class="header" role="banner">
          <a class="logo" href="#" id="btnBack" aria-label="Volver al cat√°logo">
            <img src="img/logo.png" alt="" />
            <span class="brand">Carletes Games</span>
          </a>
          <h2 class="title" id="gameTitle">Juego</h2>
        </div>

        <div class="stage" aria-label="Juego">
          <div class="stage-inner">
            <iframe id="gameFrame" class="game" src="" title="Juego"
              allow="autoplay; fullscreen; gamepad; clipboard-read; clipboard-write"
              allowfullscreen referrerpolicy="no-referrer"></iframe>
          </div>
          <div class="controls">
            <span class="hint" id="gameHint">Consejo: gira tu iPad a horizontal para m√°s espacio.</span>
            <div style="display:flex; gap:10px;">
              <button class="btn ghost" id="btnBack2">‚Üê Men√∫</button>
              <a class="btn" href="https://www.google.com" rel="nofollow">P√°nico</a>
            </div>
          </div>
        </div>
      </section>

      <footer>Carletes Games ¬∑ Hecho con üíô por Carletes ¬∑ Usa aud√≠fonos üòâ</footer>
    </div>
  </div>

  <!-- ===== MODAL LEGAL ===== -->
  <div id="legalModal" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="legal-title">
      <h2 id="legal-title">Aviso importante</h2>
      <p>
        Accedes bajo tu propia responsabilidad y <strong>deslindas a ‚Äúcarletes‚Äù</strong> de cualquier uso indebido de esta p√°gina o de sus contenidos.
        Si no est√°s de acuerdo, presiona ‚ÄúCancelar‚Äù.
      </p>
      <div class="actions">
        <button id="btn-accept" class="btn">Acepto</button>
        <button id="btn-cancel" class="btn ghost">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- ===== Firebase + L√≥gica (SPA + Analytics) ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAnalytics, logEvent, setUserId, setUserProperties } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
    import {
      getAuth, onAuthStateChanged, updateProfile, signOut,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyAdIYosKvktrWeuoyrupSVRLE3ekfv74IU",
      authDomain: "carletes-games.firebaseapp.com",
      projectId: "carletes-games",
      storageBucket: "carletes-games.firebasestorage.app",
      messagingSenderId: "6199017607",
      appId: "1:6199017607:web:f1a2409202bdf08e3bf822",
      measurementId: "G-DS1SXZ8QN2"
    };

    // Init + Analytics
    const app = initializeApp(firebaseConfig);
    let analytics; try { analytics = getAnalytics(app); } catch(_) {}
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });

    // Elements
    const authView   = document.getElementById('authView');
    const appView    = document.getElementById('appView');
    const loaderTxt  = document.getElementById('status');

    const tabLogin   = document.getElementById('tab-login');
    const tabSignup  = document.getElementById('tab-signup');
    const panelLogin = document.getElementById('panel-login');
    const panelSignup= document.getElementById('panel-signup');

    const loginEmail = document.getElementById('login-email');
    const loginPass  = document.getElementById('login-password');
    const signupName = document.getElementById('signup-name');
    const signupNick = document.getElementById('signup-nick');
    const signupEmail= document.getElementById('signup-email');
    const signupPass = document.getElementById('signup-password');

    const btnLoginEmail  = document.getElementById('btn-login-email');
    const btnSignupEmail = document.getElementById('btn-signup-email');
    const btnGoogle      = document.getElementById('btn-google');

    const legalModal = document.getElementById('legalModal');
    const btnAccept  = document.getElementById('btn-accept');
    const btnCancel  = document.getElementById('btn-cancel');

    const btnCopy    = document.getElementById('btn-copy-link');
    const btnLogout  = document.getElementById('btn-logout');
    const profileBtn = document.getElementById('profileBtn');
    const profileMenu= document.getElementById('profileMenu');

    const elWelcome = document.getElementById('welcome');
    const elUser    = document.getElementById('userName');
    const elNick    = document.getElementById('userNick');
    const elAvatar  = document.getElementById('avatar');

    // Cat√°logo y player
    const gridEl    = document.getElementById('menu');
    const heroCat   = document.querySelector('.hero-catalog');
    const player    = document.getElementById('playerView');
    const gameFrame = document.getElementById('gameFrame');
    const gameTitle = document.getElementById('gameTitle');
    const btnBack   = document.getElementById('btnBack');
    const btnBack2  = document.getElementById('btnBack2');
    const btnRandom = document.getElementById('btn-random');

    // Mostrar/ocultar men√∫ al tocar la foto
    profileBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      profileMenu.classList.toggle('hidden');
    });
    document.addEventListener('click', (e) => {
      if (!profileMenu.classList.contains('hidden')) {
        if (!profileMenu.contains(e.target) && !profileBtn.contains(e.target)) {
          profileMenu.classList.add('hidden');
        }
      }
    });

    // ===== SIEMPRE PEDIR INICIAR SESI√ìN =====
    try { await signOut(auth); } catch(_) {}

    // Modal legal
    btnAccept.addEventListener('click', () => { legalModal.style.display = 'none'; });
    btnCancel.addEventListener('click', () => { try { window.top.close(); } catch { history.back(); } });

    // Tabs
    function setTab(which){
      const isLogin = which === 'login';
      tabLogin.classList.toggle('active', isLogin);
      tabSignup.classList.toggle('active', !isLogin);
      panelLogin.style.display  = isLogin ? 'block' : 'none';
      panelSignup.style.display = isLogin ? 'none'  : 'block';
    }
    tabLogin.addEventListener('click', () => setTab('login'));
    tabSignup.addEventListener('click', () => setTab('signup'));

    // Helpers
    function status(msg){ loaderTxt.textContent = msg; }
    function disableAuth(disabled){ [btnLoginEmail, btnSignupEmail, btnGoogle].forEach(b => b.disabled = disabled); }
    function readUrlUser(){
      const params = new URLSearchParams(location.search);
      let name = params.get('user') || '';
      name = name.replace(/[<>]/g, '').trim();
      if (name.length > 40) name = name.slice(0, 40) + '‚Ä¶';
      return name;
    }
    function buildWelcome(user){
      const who  = readUrlUser() || user?.displayName || user?.email || 'usuario';
      const nick = localStorage.getItem('carletes_nick') || new URLSearchParams(location.search).get('nick') || '';
      elUser.textContent = who;
      elNick.textContent = nick || '‚Äî';
      if (user?.photoURL) { elAvatar.src = user.photoURL; elAvatar.style.display='block'; }
      elWelcome.textContent = `¬°Hola, ${who}! Bienvenido a Carletes Games. Te presentamos una colecci√≥n de juegos lista para disfrutar en tu iPad. Recuerda que en caso de conducta inapropiada, podr√≠as ocasionar el baneo de tu cuenta. ¬°Esperamos que disfrutes de la experiencia!`;
    }

    // ====== Lista de juegos (f√°cil de extender) ======
    const GAMES = [
      { id:'drivemad',       name:'Drive Mad',           thumb:'img/drivemad.png',                         frame:'gamefiles/DriveMad/index.html' },
      { id:'monkeymart',     name:'Monkey Mart',         thumb:'img/monkeymart.png',                        frame:'https://carletes2010.github.io/Monkey-Mart/' },
      { id:'subwaysurfers',  name:'Subway Surfers',      thumb:'img/subway-surfers-haunted-hood.webp',      frame:'gamefiles/Subway-Surfers-Haunted-Hood-main/index.html' },
      { id:'uno',            name:'UNO',                 thumb:'img/uno.jpg',                               frame:'gamefiles/uno/index.html' },
      { id:'clashroyale',    name:'Clash Royale',        thumb:'img/ClashRoyale.png',                        frame:'gamefiles/ClashRoyale/index.html' },
      { id:'blockblast',     name:'Block Blast',         thumb:'img/blockblast.jpg',                         frame:'gamefiles/blockblast/index.html' },
      { id:'retrobowl',      name:'Retro Bowl',          thumb:'img/retrobowl.png',                          frame:'gamefiles/RetroBowl/index.html' },
      { id:'angrybirds',     name:'Angry Birds',         thumb:'img/angrybirds.png',                         frame:'gamefiles/angrybirds/fullscreen.html' },
      { id:'youtube',        name:'Youtube Unblocked',   thumb:'img/YT.png',                                 frame:'https://carletes2010.github.io/youtube/' },
      { id:'moneyroller',    name:'Money Roller',        thumb:'img/money-roller.png',                       frame:'gamefiles/money-roller-main/index.html' },
      { id:'pool8',          name:'8 Ball Pool',         thumb:'img/8ballpool.png',                          frame:'gamefiles/8-ball-pool-main/index.html' },
      { id:'jetpack',        name:'Jetpack Joyride',     thumb:'img/Jetpack.png',                            frame:'gamefiles/Jetpack-Joyride-main/index.html' },
      { id:'tinyfishing',    name:'Tiny-Fishing',        thumb:'img/tiny-fishing.png',                       frame:'gamefiles/Tiny-Fishing-main/index.html' },
      { id:'ninjafruit',     name:'Ninja-Fruit',         thumb:'img/fruit-ninja.png',                        frame:'gamefiles/Ninja-Fruit-main/index.html' },
      { id:'asmallworldcup', name:'A Small World Cup',   thumb:'img/asmallworldcup.png',                     frame:'gamefiles/asmallworldcup-main/index.html' },
      { id:'eggycar',        name:'EGGY CAR',            thumb:'img/Eggy-Car.png',                           frame:'gamefiles/eggycar-main/index.html' },
      { id:'clashoftanks',   name:'Clash Of Tanks',      thumb:'img/clash-of-tanks.png',                     frame:'gamefiles/ClashOfTanks-gh-pages/index.html' },
      { id:'penalty2',       name:'Penalty Shooters 2',  thumb:'img/penalty-shooters-2.png',                 frame:'gamefiles/penalty-shooters-2-main/index.html' }
    ];

    function renderGrid(){
      gridEl.innerHTML = GAMES.map(g => `
        <article class="card" data-game="${g.id}">
          <a href="#/play/${g.id}" class="play-link" data-game="${g.id}">
            <img src="${g.thumb}" alt="${g.name}" class="thumb">
          </a>
          <div class="meta">
            <span class="title-game">${g.name}</span>
            <a href="#/play/${g.id}" class="play" data-game="${g.id}">Jugar</a>
          </div>
        </article>`).join('');
    }

    function findGame(id){ return GAMES.find(g => g.id === id); }

    function openGame(id){
      const g = findGame(id); if (!g) return;
      document.title = `Carletes Games ¬∑ ${g.name}`;
      gameTitle.textContent = g.name;
      gameFrame.src = g.frame;

      heroCat.classList.add('hidden');
      gridEl.classList.add('hidden');
      player.classList.remove('hidden');

      try { if (analytics) logEvent(analytics, 'select_content', { content_type: 'game', item_id: id, item_name: g.name }); } catch {}

      if(location.hash !== `#/play/${id}`) history.pushState({ id }, '', `#/play/${id}`);
    }

    function backToCatalog(){
      document.title = 'Carletes Games ‚Äî Acceso + Cat√°logo';
      gameFrame.src = '';
      player.classList.add('hidden');
      heroCat.classList.remove('hidden');
      gridEl.classList.remove('hidden');
      if(location.hash.startsWith('#/play/')) history.pushState({}, '', '#/');
    }

    // Delegaci√≥n de clicks en el grid
    gridEl.addEventListener('click', (e) => {
      const t = e.target.closest('[data-game]');
      if (!t) return;
      e.preventDefault();
      openGame(t.getAttribute('data-game'));
    });

    // Botones ‚Äú‚Üê Men√∫‚Äù
    btnBack.addEventListener('click', (e)=>{ e.preventDefault(); backToCatalog(); });
    btnBack2.addEventListener('click', (e)=>{ e.preventDefault(); backToCatalog(); });

    // Router por hash (#/play/id)
    function handleRoute(){
      const m = location.hash.match(/^#\/play\/([\w-]+)/);
      if (m) openGame(m[1]); else backToCatalog();
    }
    window.addEventListener('popstate', handleRoute);
    window.addEventListener('hashchange', handleRoute);

    // Bot√≥n: elegir juego random
    btnRandom.addEventListener('click', (e)=>{
      e.preventDefault();
      const r = Math.floor(Math.random()*GAMES.length);
      const g = GAMES[r];
      try { if (analytics) logEvent(analytics, 'random_play', { item_id: g.id, item_name: g.name }); } catch {}
      openGame(g.id);
    });

    // ===== APP flow =====
    function showApp(user){
      authView.classList.add('hidden');
      appView.classList.remove('hidden');
      buildWelcome(user);
      try {
        if (analytics && user?.uid) {
          setUserId(analytics, user.uid);
          const nick = localStorage.getItem('carletes_nick') || new URLSearchParams(location.search).get('nick') || '';
          setUserProperties(analytics, { nick: nick || undefined });
        }
      } catch {}
      renderGrid();
      if (location.hash) handleRoute();
    }

    // Email/Password
    btnLoginEmail.addEventListener('click', async () => {
      const email = loginEmail.value.trim();
      const pass  = loginPass.value.trim();
      if(!email || !pass) return status('Correo y contrase√±a son requeridos.');
      try {
        disableAuth(true);
        await signInWithEmailAndPassword(auth, email, pass);
        status('Inicio de sesi√≥n correcto.');
        try { if (analytics) logEvent(analytics, 'login', { method: 'password' }); } catch {}
      } catch (e) {
        status(mapAuthError(e));
      } finally { disableAuth(false); }
    });

    // Signup con nombre y apodo
    btnSignupEmail.addEventListener('click', async () => {
      const name  = signupName.value.trim();
      const nick  = signupNick.value.trim();
      const email = signupEmail.value.trim();
      const pass  = signupPass.value.trim();
      if(!name)  return status('Por favor, escribe tu nombre.');
      if(!nick)  return status('Por favor, escribe tu apodo.');
      if(!email) return status('El correo es requerido.');
      if(pass.length < 6) return status('Contrase√±a m√≠nima de 6 caracteres.');
      try {
        disableAuth(true);
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(cred.user, { displayName: name });
        localStorage.setItem('carletes_nick', nick);
        status('Cuenta creada e iniciada correctamente.');
        try { if (analytics) logEvent(analytics, 'sign_up', { method: 'password' }); } catch {}
      } catch (e) {
        status(mapAuthError(e));
      } finally { disableAuth(false); }
    });

    // Google con fallback a redirect
    btnGoogle.addEventListener('click', async () => {
      try {
        disableAuth(true);
        await signInWithPopup(auth, provider);
        status('Autenticado con Google.');
        try { if (analytics) logEvent(analytics, 'login', { method: 'Google' }); } catch {}
      } catch (e) {
        const fallbackCodes = ['auth/popup-blocked','auth/popup-closed-by-user','auth/operation-not-supported-in-this-environment','auth/auth-domain-config-required','auth/unauthorized-domain'];
        if (fallbackCodes.includes(e?.code)) {
          try {
            status('Abriendo Google con redirecci√≥n‚Ä¶');
            await signInWithRedirect(auth, provider);
            return;
          } catch (e2) {
            status(mapAuthError(e2));
          }
        } else {
          status(mapAuthError(e));
        }
      } finally {
        disableAuth(false);
      }
    });

    // Procesar resultado de redirect
    (async () => {
      try {
        const result = await getRedirectResult(auth);
        if (result && result.user) {
          status(`Autenticado como ${result.user.displayName || result.user.email}.`);
          try { if (analytics) logEvent(analytics, 'login', { method: 'Google-redirect' }); } catch {}
          showApp(result.user);
        }
      } catch (e) {
        status(mapAuthError(e));
      }
    })();

    // Estado de sesi√≥n ‚Üí mostrar app
    onAuthStateChanged(auth, (user) => {
      if (user) showApp(user);
    });

    // Cerrar sesi√≥n desde el men√∫ de perfil
    btnLogout.addEventListener('click', async () => {
      try {
        await signOut(auth);
        try { if (analytics) logEvent(analytics, 'logout'); } catch {}
      } finally {
        location.reload();
      }
    });


    // Estado inicial
    setTab('login');
  </script>
</body>
</html>
